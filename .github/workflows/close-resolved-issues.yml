name: Auto-Close Resolved Issues

on:
  pull_request:
    types: [opened, synchronize, edited]
    branches: [main, develop]

jobs:
  close-issues:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: read
      issues: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Extract issue numbers from commit messages and PR body
        id: extract-issues
        run: |
          # Get all commit messages and PR body
          COMMIT_MESSAGES=$(git log ${{ github.event.pull_request.base.sha }}..${{ github.sha }} --pretty=format:"%B")
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # Combine all text
          ALL_TEXT="${COMMIT_MESSAGES}
          ${PR_BODY}"
          
          # Extract issue numbers from "Fixes #XX", "Closes #XX", "Resolves #XX" patterns
          ISSUES=$(echo "$ALL_TEXT" | grep -oE '(Fixes|Closes|Resolves|Fix|Close|Resolve):\s*#[0-9]+' | grep -oE '#[0-9]+' | sed 's/#//' | sort -u)
          
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          
          if [ -n "$ISSUES" ]; then
            echo "Found issues: $ISSUES"
          else
            echo "No issues found"
          fi
      
      - name: Close resolved issues
        if: steps.extract-issues.outputs.issues != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issues = '${{ steps.extract-issues.outputs.issues }}'.split('\n').filter(i => i.trim());
            const prNumber = context.payload.pull_request.number;
            const prUrl = context.payload.pull_request.html_url;
            const prTitle = context.payload.pull_request.title;

            for (const issueNum of issues) {
              if (!issueNum) continue;

              try {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNum)
                });

                if (issue.data.state === 'closed') {
                  console.log(`Issue #${issueNum} is already closed`);
                  continue;
                }

                const commentBody = `## ✅ Resolved by PR\n\nThis issue has been resolved by PR #${prNumber}: **${prTitle}**\n\n[View PR →](${prUrl})\n\n---\n*This comment was automatically generated when the PR was opened.*`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNum),
                  body: commentBody
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNum),
                  state: 'closed'
                });

                console.log(`✅ Issue #${issueNum} closed and commented`);
              } catch (error) {
                console.error(`Error processing issue #${issueNum}:`, error.message);
              }
            }
